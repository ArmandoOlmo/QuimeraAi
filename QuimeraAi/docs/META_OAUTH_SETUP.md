# Meta OAuth Setup Guide

This guide explains how to set up Meta OAuth for automatic configuration of WhatsApp Business, Facebook Messenger, and Instagram DMs in Quimera AI.

## Overview

The Meta OAuth integration allows users to connect their social channels with a single click, eliminating the need to manually copy access tokens and IDs.

## Prerequisites

1. A Meta Business Account
2. A Facebook App with required permissions
3. Firebase Cloud Functions deployed

## Step 1: Create a Meta App

1. Go to [Meta for Developers](https://developers.facebook.com/)
2. Click "Create App"
3. Select "Business" as the app type
4. Enter your app details

## Step 2: Configure App Products

Add the following products to your app:

### Facebook Login for Business
- Enable OAuth for web
- Add redirect URI: `https://YOUR_DOMAIN/auth/meta/callback` (or your Cloud Function URL)

### Messenger
- Add the Messenger product to enable messaging

### WhatsApp
- Add WhatsApp product if you have WhatsApp Business API access

### Instagram
- Add Instagram Basic Display for DM access

## Step 3: Configure Permissions

Request the following permissions in your app:

```
# Core
public_profile
email

# Pages & Messaging
pages_messaging
pages_manage_metadata
pages_read_engagement
pages_show_list

# WhatsApp Business
whatsapp_business_messaging
whatsapp_business_management

# Instagram
instagram_basic
instagram_manage_messages

# Business
business_management
```

## Step 4: Set Firebase Environment Variables

Set these environment variables for your Cloud Functions:

```bash
# Using Firebase CLI
firebase functions:config:set meta.app_id="YOUR_META_APP_ID"
firebase functions:config:set meta.app_secret="YOUR_META_APP_SECRET"
firebase functions:config:set meta.redirect_uri="https://us-central1-YOUR_PROJECT.cloudfunctions.net/metaOAuth-callback"
```

Or set them in your `.env` file for local development:

```env
META_APP_ID=your_app_id
META_APP_SECRET=your_app_secret
META_REDIRECT_URI=https://us-central1-your-project.cloudfunctions.net/metaOAuth-callback
```

## Step 5: Deploy Cloud Functions

Deploy the Meta OAuth Cloud Functions:

```bash
cd functions
npm run deploy
```

## Step 6: Configure Webhook URL

In the Meta Developer Console, configure your webhook URL:

- **Callback URL**: `https://us-central1-YOUR_PROJECT.cloudfunctions.net/metaOAuth-callback`
- **Verify Token**: Auto-generated by the system (visible in the dashboard after connecting)

## How It Works

### OAuth Flow

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│                  │     │                  │     │                  │
│  User clicks     │────▶│  Meta OAuth      │────▶│  Cloud Function  │
│  "Connect Meta"  │     │  Login Screen    │     │  Callback        │
│                  │     │                  │     │                  │
└──────────────────┘     └──────────────────┘     └────────┬─────────┘
                                                           │
                                                           ▼
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│                  │     │                  │     │                  │
│  Dashboard       │◀────│  Redirect with   │◀────│  Store tokens    │
│  Updated         │     │  success params  │     │  in Firestore    │
│                  │     │                  │     │                  │
└──────────────────┘     └──────────────────┘     └──────────────────┘
```

### Token Storage

Tokens are stored in Firestore at:
```
users/{userId}/projects/{projectId}/integrations/meta
```

The stored data includes:
- User access token (long-lived, ~60 days)
- Connected pages with their tokens
- WhatsApp Business Account info
- Instagram account info

### Token Refresh

Long-lived tokens last approximately 60 days. The system:
1. Tracks token expiration
2. Shows a "refresh" button when token is about to expire
3. Allows manual token refresh via the UI
4. (Optional) Scheduled function to auto-refresh tokens

## User Interface

### Connection Flow

1. User goes to Dashboard → AI Assistant → Social Channels
2. Clicks "Conectar con Meta" button
3. Redirected to Meta login
4. Grants permissions
5. Redirected back to dashboard with channels auto-configured

### Asset Selection

After connecting, users can:
- Select which Facebook Page to use
- Choose which WhatsApp Business number
- Pick Instagram account (linked to Page)

### Disconnection

Users can disconnect at any time, which:
- Removes stored tokens
- Clears channel configuration
- Keeps conversation history

## Security Considerations

1. **Token Storage**: Access tokens are stored in Firestore with security rules
2. **State Validation**: OAuth state is validated to prevent CSRF attacks
3. **Minimum Permissions**: Only request permissions actually needed
4. **Token Rotation**: Long-lived tokens are used and can be refreshed

## Troubleshooting

### "Invalid State" Error
- The OAuth request expired (10 minute timeout)
- Solution: Try connecting again

### "Access Denied" Error
- User didn't grant required permissions
- Solution: Re-authorize and accept all permissions

### "No Pages Found"
- User doesn't have admin access to any Facebook Pages
- Solution: Create or get admin access to a Facebook Page

### "Token Expired"
- Long-lived token has expired
- Solution: Click "Refresh Token" or reconnect

## API Reference

### Cloud Functions

| Function | Description |
|----------|-------------|
| `metaOAuth-init` | Initiates OAuth flow, returns auth URL |
| `metaOAuth-callback` | Handles OAuth callback, stores tokens |
| `metaOAuth-getConnection` | Gets current connection status |
| `metaOAuth-disconnect` | Removes Meta connection |
| `metaOAuth-refreshToken` | Refreshes the access token |
| `metaOAuth-selectAssets` | Selects which pages/accounts to use |

### React Hook

```typescript
const {
    status,           // 'disconnected' | 'connecting' | 'connected' | 'error'
    isLoading,
    error,
    pages,            // Available Facebook Pages
    whatsappAccounts, // Available WhatsApp numbers
    instagramAccounts,// Available Instagram accounts
    connect,          // Start OAuth flow
    disconnect,       // Remove connection
    selectAssets,     // Choose which assets to use
} = useMetaOAuth(projectId);
```

## App Review (Production)

Before going to production, you need to submit your app for review:

1. Complete all app verification requirements
2. Submit permission requests with use case explanations
3. Provide a screencast showing how the integration works
4. Wait for Meta's approval (can take 2-4 weeks)

## Support

For issues with the Meta integration:
1. Check the browser console for errors
2. Verify Cloud Function logs in Firebase Console
3. Ensure all required permissions are approved
4. Contact support if issues persist








